{% extends "../base1.html" %}

    {% block css %}
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
        }
         /* 表格容器 */
        .table-container {
            max-width: 100%;
            width: 100%;
            overflow-x: auto;
            background: white;
        }
        
        /* 固定宽度表格 */
        .data-table {
            width: 100%;
            table-layout: fixed; /* 关键：固定布局 */
            border-collapse: collapse;
            font-size: 14px;
        }
        .data-table th {
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        /* ID列固定宽度 */
        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            width: 40px;
        }
        /* 操作列固定宽度 */
        .data-table th:last-child,
        .data-table td:last-child {
            width: 140px;
        }
        .data-table th:not(:first-child):not(:last-child):not(:nth-child(2)),
        .data-table td:not(:first-child):not(:last-child):not(:nth-child(2)) {
            width: 90px; /* 总宽减去固定列，除以中间列数 */
        }
        .data-table td:not(:last-child) {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .custom-modal-lg {
            max-width: 80%;
            min-width: 60%;
        }

    </style>

        
    {% endblock %}


{% block body %}

        <!-- 筛选区域 -->
        <div class="filter-panel">
            <div class="filter-row">
                <div class="filter-item ">
                    <div>
                        <label for="variable-name">用例名称</label>
                    </div>
                    <div>
                        <input id="variable-name" class="form-control input-sm">
                    </div>
                </div>
                <div class="filter-item">
                    <label for="project">所属项目</label>
                    <input id="project-name" class="form-control input-sm">
                </div>
            </div>
            <div class="filter-actions">
                <button type="button" class="btn btn-default btn-sm btn-outline">
                    <i class="fa fa-refresh"></i> 重置
                </button>
                <button type="button" class="btn btn-primary btn-sm">
                    <i class="fa fa-search"></i> 查询
                </button>
            </div>
        </div>

        <!-- 数据主表格区域 -->
        <div class="main-panel">
        <!-- 操作按钮区域 -->
        <div class="table-actions">
            <div>
                <button type="button" class="btn btn-primary btn-sm" id="add-case-btn">
                    <i class="fa fa-plus"></i> 新增用例
                </button>
                <button type="button" class="btn btn-default btn-sm btn-outline">
                    <i class="fa fa-upload"></i> 批量导入
                </button>
                <button type="button" class="btn btn-default btn-sm btn-outline">
                    <i class="fa fa-download"></i> 导出
                </button>
            </div>
            <div>
                <button type="button" class="btn btn-default btn-sm btn-outline">
                    <i class="fa fa-refresh"></i> 刷新
                </button>
            </div>
        </div>

        <!-- 表格数据区域 -->
            <div class="table-container">
            <table class="data-table">
                <thead>
                <tr>
                    <th class="select-column">
                        <input type="checkbox" id="select-all" class="select-checkbox">
                    </th>
                    <th>ID</th>
                    <th >用例名称</th>
                    <th >描述</th>
                    <th>所属项目</th>
                    <th>更新时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                {% for var in case_querylist %}
                    <tr>
                        <td class="select-column">
                            <input type="checkbox" class="select-checkbox case-select" data-id="{{ var.id }}">
                        </td>
                        <td>{{ var.id }}</td>
                        <td>{{ var.case_name }}</td>
                        <td>{{ var.description }}</td>
                        <td>{{ var.project.prj_name }}</td>
                        <td>{{ var.updated_at|date:"Y-n-j H:i:s" }}</td>
                        <td>
                            <div class="action-box">
                               <div class="action-item">
                                   <i class="fa fa-pencil action-icon"></i>
                                   <button class="action-text" style="color: inherit; border: none;
                                   outline: none;background: transparent;" onclick="bindBtnEditEvent({{ var.id }})">编辑</button>
                               </div>
                               <div class="action-item">
                                   <i class="fa fa-copy action-icon"></i>
                                   <button class="action-text" style="color: inherit; border: none;
                                   outline: none;background: transparent;" onclick="bindBtnCopyEvent({{ var.id }})">复制</button>
                               </div>

                                <div class="action-item">
                                    <i class="fa fa-trash action-icon"></i>
                                    <a class="action-text" style="color: inherit;" href="/front/case/delete/{{ var.id }}/">删除</a>
                                </div>
                                <div class="action-item">
                                    <i class="fa fa-start action-icon"></i>
                                    <a class="action-text" style="color: inherit;" href="#">测试</a>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>

        <!-- 新增模态框 -->
                    <div class="modal fade blue-theme " id="addTestcaseModal" tabindex="-1" role="dialog">
                        <div class="modal-dialog custom-modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <h4 class="modal-title">添加测试用例</h4>
                                </div>
                                <div class="modal-body">
                                    <!-- 基本信息 -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><span class="required">*</span> 用例名称</label>
                                                <input type="text" class="form-control" id="case_name"
                                                    placeholder="请输入测试用例名称">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><span class="required">*</span> 所属项目</label>
                                                <select class="form-control" id="projectSelect" name="prj_name" required>
                                                    <option value="demo" disabled selected hidden>请选择所属项目</option>
                                                    {% for prj in project_list %}
                                                        <option value="{{ prj.id }}">{{ prj.prj_name }}</option>
                                                    {% endfor %}        
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label>备注</label>
                                                <textarea class="form-control" id="caseRemark" rows="2"
                                                        placeholder="请输入备注信息"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 操作按钮 -->
                                    <p class="text-center text-muted" style="margin-bottom: 10px;">
                                            测试步骤（可拖拽行，调整执行顺序！）
                                        </p>
                                    <div class="text-left" style="margin: 20px 0;">
                                        <button type="button" class="btn btn-primary" id="add-interface-btn">
                                            <i class="fa fa-plus"></i> 添加接口
                                        </button>
                                        <button type="button" class="btn btn-danger" onclick="deleteSelectedSteps()">
                                            <i class="fa fa-trash"></i> 删除
                                        </button>
                                    </div>

                                    <!-- 测试步骤表格 -->
                                    <div style="margin-top: 10px;">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover table-steps " id="stepTable">
                                                <thead>
                                                    <tr>
                                                        <th >
                                                            <input type="checkbox" id="selectAllSteps">
                                                        </th>
                                                        <th >序号</th>
                                                        <th >测试步骤</th>
                                                        <th >测试地址</th>
                                                        <th >接口类型</th>
                                                        <th >请求头</th>
                                                        <th >请求体</th>
                                                        <th >参数化变量</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="stepTableBody">
                                                    <!-- 步骤行将通过JavaScript动态生成 -->
                                                </tbody>
                                            </table>
                                        </div>

                                        <div id="noStepsMessage" class="no-steps" style="display: none;">
                                            <i class="fa fa-list-ul fa-3x" style="color: #ddd; margin-bottom: 15px;"></i>
                                            <p>暂无测试步骤，请点击"添加接口"按钮添加步骤</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" id="save-testcase-btn">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
        <!-- 接口选择模态框 -->
                    <div class="modal fade blue-theme " id="addInterfaceModal" tabindex="-1" role="dialog">
                        <div class="modal-dialog custom-modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <h4 class="modal-title">选择接口</h4>
                                </div>
                                <div class="modal-body">
                                    <!-- 搜索框 -->
                                    <div class="search-box" style="position: relative;"> 
                                        <input type="text" class="form-control" id="interfaceSearch" placeholder="搜索接口名称、路径或描述..." style="padding-right: 30px;"> 
                                        <i class="fa fa-search" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #666; cursor: pointer;"> </i> 
                                    </div>
                                    <!-- 接口列表 -->
                                    <div class="interface-selector" id="interfaceList">
                                        <div class="table-container">
                                                    <table class="data-table">
                                                        <thead>
                                                        <tr>
                                                            <th class="select-column">
                                                                <input type="checkbox" id="select-all" class="select-checkbox">
                                                             </th>
                                                            <th>ID</th>
                                                            <th >接口名称</th>
                                                            <th >测试对象</th>
                                                            <th >测试地址</th>
                                                            <th >接口类型</th>
                                                            <th>请求头</th>
                                                            <th >请求体</th>
                                                            <th>所属项目</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% for var in interface_querylist %}
                                                            <tr>
                                                                <td class="select-column">
                                                                    <input type="checkbox" class="select-checkbox case-select" data-id="{{ var.id }}">
                                                                </td>
                                                                <td>{{ var.id }}</td>
                                                                <td>{{ var.interface_name }}</td>
                                                                <td>{{ var.test_object }}</td>
                                                                <td>{{ var.url }}</td>
                                                                <td>{{ var.get_method_display }}</td>
                                                                <td>{{ var.header }}</td>
                                                                <td>{{ var.body }}</td>
                                                                <td>{{ var.project.prj_name }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                        </tbody>
                                                    </table>
                                                    </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="addSelectedInterfaces()">确定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
        
    </div>
</div>
{% endblock %}

{% block javascript %}
    <script>
    let editId = null
    $(document).ready(function() {
        //编辑环境对象
        bindBtnEditEvent();

        // 初始化步骤表格拖拽功能
        initStepTableSortable();

        // 初始化新增用例模态框全选功能
        $('#selectAllSteps').on('change', function() {
            $('.step-checkbox').prop('checked', this.checked);
        });

        // 搜索功能
        $('#interfaceSearch').on('keyup', function() {
            searchInterfaces($(this).val());
        });

        // 新增弹出模太框 
        $('#add-case-btn').click(function() {
            $('#addTestcaseModal').modal('show');
        });
        //接口选择弹出模太框
        $('#add-interface-btn').click(function() {
            $('#addInterfaceModal').modal('show');
        });

        // 保存接口配置
        $('#save-testcase-btn').click(function(e) {
            e.preventDefault();
            // var valData = {
            //     var_name: $('#new-val-name').val(),
            //     var_value: $('#new-val-value').val(),
            //     evn_id: $('#new-val-evn').val(),
            //     type: $('#new-val-type').val()
            // };
            // 验证数据
            // if (!valData.var_name || !valData.var_value || !valData.evn_id || !valData.type) {
            //     alert('请填写完整的变量信息');
            //     return;
            // }
            // 这里可以添加实际的保存逻辑
                if (editId) {
                    url = '/front/interface/edit/?interface_id=' + editId
                } else {
                    url = '/front/interface/add/'
                }
                $.ajax({
                    url : url,
                    type: "post",
                    // data: JSON.stringify(valData),
                    data: $("#add-interface-form").serialize(),
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    dataType:"JSON",
                    success:function (res) {
                        if (res.success){
                            alert('接口配置保存成功！');
                            location.reload();
                        }else{
                            alert(JSON.stringify(res.error) || '保存失败，请重试！');
                        }
                    }
                })
             $('#addInterfaceModal').modal('hide');
            editId = null; // 重置编辑ID
        });

        // 模态框关闭时重置表单
        $('#addInterfaceModal').on('hidden.bs.modal', function() {
            $('#add-interface-form')[0].reset();
        });
        $('#addTestcaseModal').on('hidden.bs.modal', function() {
            $('#add-testcase-form')[0].reset();
        });
    });
        //编辑环境对象
    function bindBtnEditEvent(evn_id){
                editId = evn_id
                $.ajax({
                    url : "/front/interface/select/"+evn_id+"/",
                    type: "GET",
                    dataType:"JSON",
                    success:function (res) {
                            if (res.status){
                                $('#new-env-name').val(res.data.evn_name);
                                $('#new-env-project option[value="' + res.data.project_id + '"]').prop('selected', true);
                                $('#new-env-project option[value="test"]').remove();
                                $('#new-env-description').val(res.data.description);
                                console.log('测试对象配置：', res.data.test_object_config);
                                console.log('数据库配置：', res.data.database_config);
                                $.each(res.data.test_object_config, function(index, target) {
                                    var newItem = `
                                            <div class="test-target-item panel panel-default">
                                                <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                                                    <h5 class="panel-title">测试对象 #${index+1}</h5>
                                                    <button type="button" class="btn btn-xs btn-danger remove-test-target">
                                                        <i class="fa fa-times"></i>
                                                    </button>
                                                </div>
                                                <div class="panel-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>对象名称</label>
                                                                <input type="text" class="form-control test-target-name" name="evn_name" value="${target.name}" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>访问地址</label>
                                                                <input type="text" class="form-control test-target-url" value="${target.url}" name="url" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>端口号</label>
                                                                <input type="number" class="form-control test-target-port" value="${target.port}" name="port" min="1" max="65535">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>协议类型</label>
                                                                <select class="form-control test-target-protocol ">
                                                                    <option value="HTTP">HTTP</option>
                                                                    <option value="MQTT">MQTT</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    $('.test-targets-container').append(newItem);})
                                $.each(res.data.database_config, function(index, db) {
                                    var dbItem = `
                                            <div class="database-config-item panel panel-default">
                                                <div class="panel-heading">
                                                    <h5 class="panel-title">数据库配置 #${index+1}</h5>
                                                    <button type="button" class="btn btn-xs btn-danger remove-database-config">
                                                        <i class="fa fa-times"></i>
                                                    </button>
                                                </div>
                                                <div class="panel-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>数据库类型</label>
                                                                <select class="form-control database-type" required>
                                                                    <option value="mysql">MySQL</option>
                                                                    <option value="oracle">Oracle</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>数据库名称</label>
                                                                <input type="text" class="form-control database-name" value="${db.name}" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>主机地址</label>
                                                                <input type="text" class="form-control database-host" value="${db.host}" placeholder="如：localhost" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>端口号</label>
                                                                <input type="number" class="form-control database-port" value="${db.port}" placeholder="如：3306" min="1" max="65535" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>用户名</label>
                                                                <input type="text" class="form-control database-username" value="${db.username}" placeholder="数据库用户名" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>密码</label>
                                                                <input type="password" class="form-control database-password" value="${db.password}" placeholder="数据库密码" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>`
                                    $('.database-configs-container').append(dbItem);
                                    $('.database-type').val(db.type);

                                                })
                            $("#addEnvModal").modal("show");
                            }else {
                                alert(res.error);
                                }
                    }
                });
            }
    document.addEventListener('DOMContentLoaded', function() {
            const cells = document.querySelectorAll('.data-table td:not(:last-child)');
            cells.forEach(cell => {
                if (cell.scrollWidth > cell.clientWidth) {
                    if (!cell.title) {
                        cell.title = cell.textContent;
                    }
                }
            });
        });
    </script>

{% endblock %}