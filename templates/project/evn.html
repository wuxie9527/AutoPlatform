{% extends "../base1.html" %}

    {% block css %}
        <style>
        .panel-heading {
            display: flex;
            padding: 10px 15px;
            border-bottom: 1px solid transparent;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
            justify-content: space-between;
            }
        </style>

    {% endblock %}





{% block body %}

        <!-- 筛选区域 -->
        <div class="filter-panel">
            <div class="filter-row">
                <div class="filter-item">
                    <label for="project">环境名称</label>
                    <input id="project" class="form-control input-sm">
                </div>

        </div>
            <div class="filter-actions">
                <button type="button" class="btn btn-default btn-sm btn-outline">
                    <i class="fa fa-refresh"></i> 重置
                </button>
                <button type="button" class="btn btn-primary btn-sm">
                    <i class="fa fa-search"></i> 查询
                </button>
            </div>
            </div>

        <!-- 数据主表格区域 -->
        <div class="main-panel">
        <!-- 操作按钮区域 -->
        <div class="table-actions">
            <div>
                <button type="button" class="btn btn-primary btn-sm" id="add-env-btn">
                    <i class="fa fa-plus"></i> 新增环境
                </button>
                <button type="button" class="btn btn-default btn-sm btn-outline">
                    <i class="fa fa-upload"></i> 批量导入
                </button>
                <button type="button" class="btn btn-default btn-sm btn-outline">
                    <i class="fa fa-download"></i> 导出
                </button>
            </div>
            <div>
                <button type="button" class="btn btn-default btn-sm btn-outline">
                    <i class="fa fa-refresh"></i> 刷新
                </button>
            </div>
        </div>

        <!-- 表格数据区域 -->
            <div class="table-responsive">
            <table class="data-table">
                <thead>
                <tr>
                    <th class="select-column">
                        <input type="checkbox" id="select-all" class="select-checkbox">
                    </th>
                    <th>ID</th>
                    <th>名称</th>
                    <th>描述</th>
                    <th>所属项目</th>
                    <th>更新时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                {% for evn in evn_querylist %}
                    <tr>
                        <td class="select-column">
                            <input type="checkbox" class="select-checkbox case-select" data-id="{{ evn.id }}">
                        </td>
                        <td>{{ evn.id }}</td>
                        <td>{{ evn.evn_name }}</td>
                        <td>{{ evn.description }}</td>
                        <td>{{ evn.project.prj_name }}</td>
                        <td>{{ evn.updated_at|date:"Y-n-j H:i:s" }}</td>
                        <td>
                            <div class="action-box">
                               <div class="action-item">
                                   <i class="fa fa-pencil action-icon"></i>
                                   <button class="action-text" style="color: inherit; border: none;
                                   outline: none;background: transparent;" onclick="bindBtnEditEvent({{ evn.id }})">编辑</button>
                               </div>

                                <div class="action-item">
                                    <i class="fa fa-trash action-icon"></i>
                                    <a class="action-text" style="color: inherit;" href="/front/evn/delete/{{ evn.id }}/">删除</a>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>

        <!-- 新增模态框 -->
        <div class="modal fade" id="addEnvModal" tabindex="-1" role="dialog" aria-labelledby="addEnvModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                     </button>
                <h4 class="modal-title" id="addEnvModalLabel">新增测试环境</h4>
            </div>
            <div class="modal-body">
                <form id="add-env-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="new-env-name">环境名称 *</label>
                                <input type="text" class="form-control" name="evn_name" id="new-env-name" placeholder="请输入环境名称" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="new-env-project">所属项目</label>
                                <select class="form-control" id="new-env-project" name="environment_project" required>
                                    <option value="demo" selected>请选择所属项目</option>
                                    {% for prj in project_list %}
                                        <option value={{ prj.prj_id }}>{{ prj.prj_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="new-env-description">描述</label>
                                <input type="text" class="form-control" id="new-env-description" name="description">
                            </div>
                        </div>

                    </div>

                    <!-- 测试对象配置区域 -->
                    <div class="form-group">
                        <label>测试对象配置</label>
                        <div class="test-targets-container">
                            <!-- <div class="test-target-item panel panel-default">
                                <div class="panel-heading">
                                    <h5 class="panel-title">测试对象 #1</h5>
                                    <button type="button" class="btn btn-xs btn-danger remove-test-target">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>对象名称</label>
                                                <input type="text" name="test_object_config" class="form-control test-target-name" placeholder="如：工单服务、财务系统" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>访问地址</label>
                                                <input type="text" name="ip" class="form-control test-target-url" placeholder="如：127.0.0.1:8000" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label>协议类型</label>
                                                <select class="form-control test-target-protocol" name="xyType">
                                                    <option value="http">HTTP</option>
                                                    <option value="MQTT">MQTT</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div> -->
                        </div>
                        <button type="button" class="btn btn-default btn-sm" id="add-test-target">
                            <i class="fa fa-plus"></i> 添加测试对象
                        </button>
                    </div>

                    <!-- 数据库配置区域 -->
                    <div class="form-group">
                        <label>数据库配置</label>
                        <div class="database-configs-container">
                            <!-- <div class="database-config-item panel panel-default">
                                <div class="panel-heading">
                                    <h5 class="panel-title">数据库配置 #1</h5>
                                    <button type="button" class="btn btn-xs btn-danger remove-database-config">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>数据库类型</label>
                                                <select class="form-control database-type" name="dnType">
                                                    <option value="mysql">MySQL</option>
                                                    <option value="ORCLE">ORCLE</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>连接名称</label>
                                                <input type="text" name="dbname" class="form-control database-name" placeholder="如：主库、缓存库">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>主机地址</label>
                                                <input type="text" name="ip" class="form-control database-host" placeholder="如：localhost">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>端口号</label>
                                                <input type="number" name="port" class="form-control database-port" placeholder="如：3306" min="1" max="65535">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>用户名</label>
                                                <input type="text" name="username" class="form-control database-username" placeholder="数据库用户名">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>密码</label>
                                                <input type="password" name="password" class="form-control database-password" placeholder="数据库密码">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div> -->
                        </div>
                        <button type="button" class="btn btn-default btn-sm" id="add-database-config">
                            <i class="fa fa-plus"></i> 添加数据库配置
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="save-env-btn">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
    <script>
    var editId = null
    $(document).ready(function() {
        //编辑环境对象
        bindBtnEditEvent();

        // 新增弹出模太框
        $('#add-env-btn').click(function() {
            $('#addEnvModal').modal('show');
        });


        // 添加测试对象
        $('#add-test-target').click(function() {
            var index = $('.test-target-item').length + 1;
            var newItem = `
                <div class="test-target-item panel panel-default">
                    <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                        <h5 class="panel-title">测试对象 #${index}</h5>
                        <button type="button" class="btn btn-xs btn-danger remove-test-target">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>对象名称</label>
                                    <input type="text" class="form-control test-target-name" placeholder="如：硬件中心服务、工单服务" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>访问地址</label>
                                    <input type="text" class="form-control test-target-url" placeholder="如：http://api.example.com" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>端口号</label>
                                    <input type="number" class="form-control test-target-port" placeholder="如：8080" min="1" max="65535">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>协议类型</label>
                                    <select class="form-control test-target-protocol">
                                        <option value="http">HTTP</option>
                                        <option value="MQTT">MQTT</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('.test-targets-container').append(newItem);
        });

        // 删除测试对象
        $(document).on('click', '.remove-test-target', function() {
            if ($('.test-target-item').length >= 1) {
                $(this).closest('.test-target-item').remove();
                // 重新编号
                $('.test-target-item').each(function(index) {
                    $(this).find('.panel-title').text('测试对象 #' + (index + 1));
                });
            } 
            // else {
            //     alert('至少需要保留一个测试对象');
            // }
        });

        // 添加数据库配置
        $('#add-database-config').click(function() {
            var index = $('.database-config-item').length + 1;
            var newItem = `
                <div class="database-config-item panel panel-default">
                    <div class="panel-heading">
                        <h5 class="panel-title">数据库配置 #${index}</h5>
                        <button type="button" class="btn btn-xs btn-danger remove-database-config">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>数据库类型</label>
                                    <select class="form-control database-type" required>
                                        <option value="">请选择数据库类型</option>
                                        <option value="mysql">MySQL</option>
                                        <option value="oracle">Oracle</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>数据库名称</label>
                                    <input type="text" class="form-control database-name" placeholder="如：station_support" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>主机地址</label>
                                    <input type="text" class="form-control database-host" placeholder="如：localhost" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>端口号</label>
                                    <input type="number" class="form-control database-port" placeholder="如：3306" min="1" max="65535" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>用户名</label>
                                    <input type="text" class="form-control database-username" placeholder="数据库用户名" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>密码</label>
                                    <input type="password" class="form-control database-password" placeholder="数据库密码" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('.database-configs-container').append(newItem);
        });

        // 删除数据库配置
        $(document).on('click', '.remove-database-config', function() {
            if ($('.database-config-item').length >= 1) {
                $(this).closest('.database-config-item').remove();
                // 重新编号
                $('.database-config-item').each(function(index) {
                    $(this).find('.panel-title').text('数据库配置 #' + (index + 1));
                });
            } else {
                alert('至少需要保留一个数据库配置');
            }
        });

        // 保存环境配置
        $('#save-env-btn').click(function(e) {
            e.preventDefault();
            var envData = {
                evn_name: $('#new-env-name').val(),
                project: $('#new-env-project').val(),
                description : $('#new-env-description').val(),
                test_object_config: [],
                database_config: []
            };
            // 收集测试对象数据
            $('.test-target-item').each(function () {
                var targetData = {
                    name: $(this).find('.test-target-name').val(),
                    url: $(this).find('.test-target-url').val(),
                    port: $(this).find('.test-target-port').val(),
                    protocol: $(this).find('.test-target-protocol').val()
                };
                envData.test_object_config.push(targetData);
            });

            // 收集数据库配置数据
            $('.database-config-item').each(function () {
                var dbData = {
                    type: $(this).find('.database-type').val(),
                    name: $(this).find('.database-name').val(),
                    host: $(this).find('.database-host').val(),
                    port: $(this).find('.database-port').val(),
                    username: $(this).find('.database-username').val(),
                    password: $(this).find('.database-password').val()
                };
                envData.database_config.push(dbData);
            });

            // 验证数据
            if (!envData.evn_name) {
                alert('请填写完整的环境基本信息');
                return;
            }

            // if (envData.test_object_config.length === 0) {
            //     alert('请至少添加一个测试对象');
            //     return;
            // }

            // if (envData.database_config.length === 0) {
            //     alert('请至少添加一个数据库配置');
            //     return;
            // }

            $('#addEnvModal').modal('hide');
            // 这里可以添加实际的保存逻辑
                if (editId) {
                    url = '/front/evn/edit/?evn_id=' + editId
                } else {
                    url = '/front/evn/add/'
                }
                $.ajax({
                    url : url,
                    type: "post",
                    data: JSON.stringify(envData),
                    contentType: "application/json",
                    dataType:"JSON",
                    success:function (res) {
                        if (res.success){
                            alert('环境配置保存成功！');
                            location.reload();
                        }else{
                            alert('保存出错');
                        }
                    }
                })
            editId = null; // 重置编辑ID
        });

        // 模态框关闭时重置表单
        $('#addEnvModal').on('hidden.bs.modal', function() {
            $('#add-env-form')[0].reset();
            // $('.test-target-item:gt(0)').remove();
            $('.test-target-item').remove();
            $('.database-config-item').remove();
        });
    });
        //编辑环境对象
    function bindBtnEditEvent(evn_id){
                editId = evn_id
                $.ajax({
                    url : "/front/evn/select/"+evn_id+"/",
                    type: "GET",
                    dataType:"JSON",
                    success:function (res) {
                            if (res.status){
                                $('#new-env-name').val(res.data.evn_name);
                                $('#new-env-project option[value="' + res.data.project_id + '"]').prop('selected', true);
                                $('#new-env-project option[value="test"]').remove();
                                $('#new-env-description').val(res.data.description);
                                console.log('测试对象配置：', res.data.test_object_config);
                                console.log('数据库配置：', res.data.database_config);
                                $.each(res.data.test_object_config, function(index, target) {
                                    var newItem = `
                                            <div class="test-target-item panel panel-default">
                                                <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                                                    <h5 class="panel-title">测试对象 #${index+1}</h5>
                                                    <button type="button" class="btn btn-xs btn-danger remove-test-target">
                                                        <i class="fa fa-times"></i>
                                                    </button>
                                                </div>
                                                <div class="panel-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>对象名称</label>
                                                                <input type="text" class="form-control test-target-name" name="evn_name" value="${target.name}" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>访问地址</label>
                                                                <input type="text" class="form-control test-target-url" value="${target.url}" name="url" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>端口号</label>
                                                                <input type="number" class="form-control test-target-port" value="${target.port}" name="port" min="1" max="65535">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>协议类型</label>
                                                                <select class="form-control test-target-protocol ">
                                                                    <option value="HTTP">HTTP</option>
                                                                    <option value="MQTT">MQTT</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    $('.test-targets-container').append(newItem);})
                                $.each(res.data.database_config, function(index, db) {
                                    var dbItem = `
                                            <div class="database-config-item panel panel-default">
                                                <div class="panel-heading">
                                                    <h5 class="panel-title">数据库配置 #${index+1}</h5>
                                                    <button type="button" class="btn btn-xs btn-danger remove-database-config">
                                                        <i class="fa fa-times"></i>
                                                    </button>
                                                </div>
                                                <div class="panel-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>数据库类型</label>
                                                                <select class="form-control database-type" required>
                                                                    <option value="mysql">MySQL</option>
                                                                    <option value="oracle">Oracle</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>数据库名称</label>
                                                                <input type="text" class="form-control database-name" value="${db.name}" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>主机地址</label>
                                                                <input type="text" class="form-control database-host" value="${db.host}" placeholder="如：localhost" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>端口号</label>
                                                                <input type="number" class="form-control database-port" value="${db.port}" placeholder="如：3306" min="1" max="65535" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>用户名</label>
                                                                <input type="text" class="form-control database-username" value="${db.username}" placeholder="数据库用户名" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>密码</label>
                                                                <input type="password" class="form-control database-password" value="${db.password}" placeholder="数据库密码" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>`
                                    $('.database-configs-container').append(dbItem);
                                    $('.database-type').val(db.type);

                                                })
                            $("#addEnvModal").modal("show");
                            }else {
                                alert(res.error);
                                }
                    }
                });
            }
    </script>

{% endblock %}